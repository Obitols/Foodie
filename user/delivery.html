<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foodie</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style2.css">
    <script src="search.js" defer></script>
    <link rel="shortcut icon" href="/images/logo.jpg" type="image/x-icon">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .main {
            height: 70vh;
            width: 90%;
            display: flex;
            justify-content: space-around;
            margin: 5%;
        }

        .bill {
            display: flex;
            flex-direction: column;
            height: 38vh;
            width: 35%;
            justify-content: space-evenly;
        }

        .bill div {
            display: flex;
            justify-content: space-between;
        }

        .main section {
            height: 55vh;
        }

        .main section form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5%;
            width: 30%;
        }

        input {
            padding: 0.6em;
            font-size: 1em;
        }

        .items {
            grid-column: 1/3;
        }

        @media (max-width:800px) {

            .main {
                flex-direction: column;
                height: 150vh;
            }

            .main .bill {
                width: 70%;
            }
        }

        @media (max-width:480px) {

            .main section form {
                grid-template-columns: 1fr;
                gap: 1%;
            }

            .items {
                grid-column: 1/2;
            }

            address input {
                width: 80vw;
            }

            .main {
                height: 140vh;
            }

            .main .bill {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <header class="navigation"></header>
    <main>
        <div class="main">
            <section>
                <h2 style=" margin-bottom: 5%;">Delivery information</h2>
                <form id="uploadForm" action="http://localhost:3000/address" method="POST" enctype="multipart/form-data">
                    <input type="text" placeholder="First name" name="fname" required>
                    <input type="text" placeholder="Last name" name="lname" required>
                    <input type="email" class="items" placeholder="Email address" name="email" required>
                    <input type="text" class="items" placeholder="Street" name="street" required>
                    <input type="text" placeholder="City" name="city" required>
                    <input type="text" placeholder="State" name="state" required>
                    <input type="text" placeholder="Zip code" name="zipcode" required>
                    <input type="text" placeholder="Contry" name="contry" required>
                    <input type="number" class="items" placeholder="Phone" name="pnumber" required>
                </form>
            </section>
            <aside class="bill">
                <h2>cart Totals</h2>
                <div>
                    <p>subtotal</p><span class="subtotal">0.00</span>
                </div>
                <hr>
                <div>
                    <p>Delivery Fee</p><span class="dfee2">0.00</span>
                </div>
                <hr>
                <div><b>Total</b> <span class="totalAmount"></span></div>
                <button style="background-color: rgb(255, 0, 0);border: none; color: white;"
                     id="uploadButton" type="button">PROCESSED TO PAYMENT</button>
            </aside>
        </div>
    </main>
    <section id="searchitems" style="display: none; margin: 0 4%; height:max-content"></section>
    <footer class="contact"></footer>
    <script src="script2.js"></script>
    <script>
         document.getElementById("uploadButton").addEventListener("click", () => {
        const form = document.getElementById("uploadForm");
        const formData = new FormData(form);

        const patterns = {
            email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
            zipcode: /^\d{6}(-\d{4})?$/,
            pnumber: /^\+?\d{10}$/
        };

        for (const [key, value] of formData) {
            if (!value.trim()) {
                alert("Please fill all the fields.");
                return;
            }

            if (patterns[key] && !patterns[key].test(value.trim())) {
                alert(`Please enter a valid ${key.replace('pnumber', 'phone number').replace('zipcode', 'ZIP code')}.`);
                return;
            }
        }

        fetch(form.action, {
            method: "POST",
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            alert(data); 
            form.reset();
            window.location.href = '/user/payment.html';
        })
        .catch(err => {
            alert("Error: " + err.message);
        });
    });
    async function displayamount() {
    const response = await fetch('http://localhost:3000/cart');
    const items = await response.json();
    const totalPrice = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    document.querySelector('.subtotal').textContent=`$${totalPrice.toFixed(2)}`;
    const totalQuantity = items.reduce((sum, item) => sum + item.quantity, 0);
    document.querySelector('.dfee2').textContent=`$${totalQuantity*5}`;
    const final =totalPrice + totalQuantity*5;
    document.querySelector('.totalAmount').textContent=`$${final.toFixed(2)}`;
    }
    displayamount();
    </script>
</body>

</html>